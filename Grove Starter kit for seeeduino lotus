//Grove Starter kit for seeeduino lotus by Ashley

#include <DHT.h>
#include "TM1637.h"

// === DHT11 設定 ===
#define DHTPIN 7
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

// === TM1637 顯示器設定 ===
#define CLK 5
#define DIO 6
TM1637 tm1637(CLK, DIO);

// === Button / LED / Rotary ===
const int buttonPin = 2;   // Button 腳位
const int ledPin = 4;      // LED 腳位
const int rotaryPin = A0;  // 電位器

int buttonState = 0;
int lastButtonState = 0;
bool ledEnabled = false;

// Rotary 狀態
int lastRotaryValue = 0;
const int rotaryThreshold = 50; // 避免太敏感

// === 顯示狀態 ===
int displayMode = 0;   // 0=溫度, 1=濕度, 2=時間

// === 軟體時鐘 ===
unsigned long prevClockMillis = 0;
int second = 0;
int minute = 59;
int hour   = 16;  // 初始時間
bool colonState = false;

// === 序列輸出 ===
unsigned long prevSerialMillis = 0;
const long serialInterval = 1000;

// === 暫存感測值 ===
float lastTemp = 0;
float lastHum = 0;

void setup() {
  pinMode(ledPin, OUTPUT);
  pinMode(buttonPin, INPUT);

  Serial.begin(9600);
  dht.begin();
  tm1637.init();
  tm1637.set(5);   // 顯示亮度

  lastRotaryValue = analogRead(rotaryPin); // 初始值
}

void loop() {
  unsigned long now = millis();

  // --- Button 控制 LED ---
  buttonState = digitalRead(buttonPin);
  if (buttonState == HIGH && lastButtonState == LOW) {
    ledEnabled = !ledEnabled; // 按一下切換 LED 狀態
    digitalWrite(ledPin, ledEnabled ? HIGH : LOW);
    delay(50); // 防抖
  }
  lastButtonState = buttonState;

  // --- Rotary 控制顯示模式 ---
  int rotaryValue = analogRead(rotaryPin);
  if (abs(rotaryValue - lastRotaryValue) > rotaryThreshold) {
    // 判斷旋轉方向
    if (rotaryValue > lastRotaryValue) {
      displayMode = (displayMode + 1) % 3;
    } else {
      displayMode = (displayMode + 2) % 3; // 往回轉
    }
    lastRotaryValue = rotaryValue;

    // === 序列輸出切換模式 ===
    if (displayMode == 0) Serial.println("Display Mode: Temperature");
    else if (displayMode == 1) Serial.println("Display Mode: Humidity");
    else if (displayMode == 2) Serial.println("Display Mode: Time");

    // LED 閃爍提示（僅在 LED 有開時）
    if (ledEnabled) {
      digitalWrite(ledPin, HIGH);
      delay(150);
      digitalWrite(ledPin, LOW);
      delay(150);
      digitalWrite(ledPin, HIGH); // 最後回到開的狀態
    }
  }

  // --- 軟體時鐘計算 ---
  if (now - prevClockMillis >= 1000) {
    prevClockMillis = now;
    second++;
    colonState = !colonState;
    if (second == 60) {
      second = 0;
      minute++;
      if (minute == 60) {
        minute = 0;
        hour++;
        if (hour == 24) hour = 0;
      }
    }
  }

  // --- 每秒更新感測器 + 輸出序列埠 ---
  if (now - prevSerialMillis >= serialInterval) {
    prevSerialMillis = now;
    lastTemp = dht.readTemperature();
    lastHum  = dht.readHumidity();

    if (!isnan(lastTemp) && !isnan(lastHum)) {
      Serial.print("Temp: "); Serial.print(lastTemp, 1); Serial.print(" *C, ");
      Serial.print("Hum: ");  Serial.print(lastHum, 1);  Serial.print(" %, ");
      Serial.print("Time: "); Serial.print(hour); Serial.print(":");
      if (minute < 10) Serial.print("0");
      Serial.println(minute);
    } else {
      Serial.println("DHT11 讀取失敗！");
    }
  }

  // --- 顯示器更新 ---
  if (displayMode == 0) {
    // 顯示溫度
    if (!isnan(lastTemp)) {
      int tempInt = (int)lastTemp;
      int tempDec = (int)(lastTemp * 10) % 10;
      tm1637.point(0);
      tm1637.display(0, tempInt / 10);
      tm1637.display(1, tempInt % 10);
      tm1637.display(2, tempDec);
      tm1637.display(3, 0);
    }
  } 
  else if (displayMode == 1) {
    // 顯示濕度
    if (!isnan(lastHum)) {
      int humInt = (int)lastHum;
      int humDec = (int)(lastHum * 10) % 10;
      tm1637.point(0);
      tm1637.display(0, humInt / 10);
      tm1637.display(1, humInt % 10);
      tm1637.display(2, humDec);
      tm1637.display(3, 0);
    }
  } 
  else if (displayMode == 2) {
    // 顯示時間
    tm1637.display(0, hour / 10);
    tm1637.display(1, hour % 10);
    tm1637.display(2, minute / 10);
    tm1637.display(3, minute % 10);
    tm1637.point(colonState); // 冒號閃爍
  }
}
